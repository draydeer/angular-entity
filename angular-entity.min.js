(function(t,e){"use strict";var i=e.$$minErr("$resty");e.module("Resty",["ng"]).factory("$resty",["$http","$q",function(t,i){var s=e.noop,r=e.forEach,n=e.extend,o=e.copy;function h(t,e,i,s){this.appendParams=i===true;this.compileStrictly=e!==false;this.defaults=s;this.route=t;var r,n=/[^\\]:([\w\$]+)/g,o=[];while(r=n.exec(t)){o.push(r[1])}this.routeParams=o;t=t.replace(/([^\\]):([\w\$]+)/g,"$1!@$#$2#$@!").replace("\\:",":");var h=t.indexOf("?");if(h!==-1){this.path=t.substr(0,h);this.q=t.substr(h+1)}else{this.path=t;this.q=null}}h.prototype={compileQuery:function(t){var i=this.appendParams,s=this.compileStrictly,n=this.path,h=this.route,u=this.q,p={};if(e.isObject(t)){if(this.defaults){t=o(t);for(var a in this.defaults){a in t||(t[a]=this.defaults[a])}}}else{t=this.defaults}if(e.isObject(t)){if(n){r(this.routeParams,function(e){if(e in t&&t[e]!==void 0){n=n.replace("!@$#"+e+"#$@!",t[e].toString());p[e]=true}else{if(s){throw new Error("Path parameter missing: "+e+" on "+h)}}})}if(u){r(this.routeParams,function(e){if(e in t&&t[e]!==void 0){u=u.replace("!@$#"+e+"#$@!",encodeURIComponent(t[e].toString()));p[e]=true}else{if(s){throw new Error("Path parameter missing: "+e+" on "+h)}}})}if(i){r(t,function(t,e){if(!(e in p)&&t!==void 0){u||(u="");u=u+"&"+e+"="+encodeURIComponent(t.toString())}})}}return u?n+"?"+u:n},"delete":function(e,i,s){return t.delete(this.compileQuery(e),n(s||{},{data:i}))},get:function(e,i,s){return t.get(this.compileQuery(e),n(s||{},{data:i}))},head:function(e,i,s){return t.head(this.compileQuery(e),n(s||{},{data:i}))},options:function(e,i,s){return t.options(this.compileQuery(e),i,s)},patch:function(e,i,s){return t.patch(this.compileQuery(e),i,s)},post:function(e,i,s){return t.post(this.compileQuery(e),i,s)},put:function(e,i,s){return t.put(this.compileQuery(e),i,s)},trace:function(e,i,s){return t.trace(this.compileQuery(e),i,s)}};function u(t,e){this.base=t;this.compiledRoutes={};this.defaults=null;this.deferred=[];this.errorHandler=null;this.queued=false;this.rawResponse=true;this.responseSimpleOnce=false;this.routes=e;this.successHandler=null;this.onAfterRequest=null;this.onBeforeRequest=null;this.addRoutes(e)}u.prototype={setDefaults:function(t){this.defaults=e.isObject(t)?t:null;return this},setErrorHandler:function(t){this.errorHandler=e.isFunction(t)?t:null;return this},setQueued:function(t){this.queued=t===true;return this},setRawResponse:function(t){this.rawResponse=t===true;return this},setResponseSimpleOnce:function(t){this.responseSimpleOnce=t===true;return this},setSuccessHandler:function(t){this.successHandler=e.isFunction(t)?t:null;return this},setOnAfterRequest:function(t){if(e.isFunction(t)){this.onAfterRequest=t;return this}throw new Error("Invalid [onAfterRequest] handler.")},setOnBeforeRequest:function(t){if(e.isFunction(t)){this.onBeforeRequest=t;return this}throw new Error("Invalid [onBeforeRequest] handler.")},addRoutes:function(t){if(e.isObject(t)){r(t,function(s,r){var n=false,o=true,u={},p,a,c,l;if(typeof s==="string"){a="get";c=this.base+"/"+s}else{if(e.isArray(s)){if(s.length===0){throw new Error("Route is not defined: "+r)}n=s[2]===true;u=e.isObject(s[3])?s[3]:this.defaults;a=s[1]||"get";c=this.base+"/"+s[0]}else{n=s.appendParams===true;o=s.compileStrictly!==false;u=e.isObject(s.defaults)?s.defaults:this.defaults;a=s.method||"get";if(s.route===void 0){throw new Error("Route is not defined: "+r)}c=this.base+"/"+s.route;p=e.isFunction(s.errorHandler)?s.errorHandler:null;l=e.isFunction(s.successHandler)?s.successHandler:null}}if(a in h.prototype){this.compiledRoutes[r]=c=new h(c,o,n,u);t[r]=this[r]=function(t,e,s){return i(function(i,r){if(this.onBeforeRequest){s=this.onBeforeRequest(s)}c[a](t,e,s).then(function(t){var e=this.successHandler||l;if(e){e(t.data,t)}i(this.rawResponse&&this.responseSimpleOnce===false?t:t.data);this.responseSimpleOnce=false}.bind(this),function(t){var e=this.errorHandler||p;if(e){e(t.data,t.status,t)}r(this.rawResponse&&this.responseSimpleOnce===false?t:t.status);this.responseSimpleOnce=false}.bind(this))}.bind(this))}}else{throw new Error("Http method is not defined: "+a)}}.bind(this))}return this},compile:function(t,e){if(t in this.compiledRoutes){return this.compiledRoutes[t].compileQuery(e)}throw new Error("Route is not defined: "+t)}};function p(t,e){return new u(t,e)}return p}])})(window,window.angular);(function(t,e){"use strict";var i=e.$$minErr("$entity");e.module("Entity",["ng","Resty"]).factory("$entity",["$resty","$q",function(t,i){var s=e.noop,r=e.forEach,n=e.extend,o=e.copy;var h={getAll:function(){return i.resolve()},getOne:function(){return i.resolve()},create:function(){return i.resolve()},"delete":function(){return i.resolve()},update:function(){return i.resolve()}};function u(t,i,s,n,o){if(e.isString(t)===false){throw new Error("Incorrect [alias].")}if(e.isString(s)===false&&e.isFunction(s)===false){throw new Error("Incorrect [mappedProperty].")}if(e.isObject(n)===false){n=h}this.alias=t;this.allMethod="getAll";this.delMethod="delete";this.defaults=void 0;this.k=null;this.mappedProperty=s;this.methods=o&&{};this.modelCache={};this.modelCacheIndex=1e7;this.modelFactory=l;this.modelMapper=null;this.oneMethod="getOne";this.putMethods=["create","update"];this.relations={};this.rootScope=i.$applyAsync?i:null;this.scope=i;this.transport=n;this.transportOptions={};if(n.routes){r(n.routes,function(t,i){if(e.isFunction(s)){this[i]=function(){return t.call(n,this.mappedProperty(this.scope,this.k),this.mappedProperty(this.scope,this.k))}.bind(this)}else{this[i]=function(){return t.call(n,this.get(this.k),this.get(this.k))}.bind(this)}}.bind(this))}if(o){r(o,function(t,i){if(e.isString(t)){this.methods[i]=this[t]}else{this.methods[i]=t}}.bind(this))}}u.RELATION_ONE_TO_ONE=0;u.RELATION_ONE_TO_MANY=1;u.prototype={get:function(t,i){t=t!==void 0?t.toString().split("."):void 0;var s,r,n;if(e.isFunction(this.mappedProperty)){n=this.mappedProperty(this,t&&t[0])}else if(t===void 0){n=this.scope[this.mappedProperty]}else if(t[0]in this.scope[this.mappedProperty]){n=this.scope[this.mappedProperty]}else{throw new Error("Key is not defined: "+(t&&t[0]))}if(t===void 0){return n}for(s=0,r=t.length;s<r;s++){if(t[s]in n){n=n[t[s]]}else{return i}}return n},set:function(t,i){t=t.toString().split(".");var s,r,n;if(e.isFunction(this.mappedProperty)){n=this.mappedProperty(this,t&&t[0],i)}else if(t[0]in this.scope[this.mappedProperty]){n=this.scope[this.mappedProperty]}else{if(e.isArray(this.scope[this.mappedProperty])){t[0]=this.scope[this.mappedProperty].push({})-1}else{this.scope[this.mappedProperty][t[0]]={}}n=this.scope[this.mappedProperty]}for(s=0,r=t.length-1;s<r;s++){n=t[s]in n&&e.isObject(n[t[s]])?n[t[s]]:n[t[s]]={}}if(e.isArray(n)&&t[s]>=n.length){n.push(i);this.apply();return i}n[t[s]]=i;this.apply();return t[s]},getRelated:function(t,e){if(!(t in this.relations)){throw new Error("Relation is not defined: "+t)}},getRoot:function(t){if(!(t in this.scope[this.mappedProperty])){throw new Error("Key is not defined: "+t)}return this.scope[this.mappedProperty][t]},setAll:function(t){this.allMethod=t;return this},setDefaults:function(t){this.defaults=t;return this},setDel:function(t){this.delMethod=t;return this},setOne:function(t){this.oneMethod=t;return this},setPut:function(t,e){this.putMethods=[t,e];return this},setModelMapper:function(t){this.modelMapper=t;return this},setOneToOne:function(t,e,i,s){this.relations[t]=[e.setOneToOne(this.alias,u.RELATION_ONE_TO_ONE),u.RELATION_ONE_TO_ONE,i,s];return this},setOneToMany:function(t,e,i,s){this.relations[t]=[e.setOneToOne(this.alias,u.RELATION_ONE_TO_ONE),u.RELATION_ONE_TO_MANY,i,s];return this},setTransport:function(t){this.transport=t;return this},setTransportOptions:function(t){this.transportOptions=e.isObject(t)?t:{};return this},setRelated:function(t,e,i){if(!(t in this.relations)){throw new Error("Relation is not defined: "+t)}return this},setRootScope:function(t){if(!t.$applyAsync){throw new Error("Is not [$scope].")}this.rootScope=t;return this},all:function(t){if(e.isFunction(this.transport[this.allMethod])===false){throw new Error("[getAll] transport method required.")}return i(function(i,s){this.transport.responseSimpleOnce=true;this.transport[this.allMethod](t).then(function(t){e.isFunction(this.mappedProperty)?this.mappedProperty(this.scope,t,true):this.scope[this.mappedProperty]=t;i(t)}.bind(this),s)}.bind(this))},append:function(t,i){if(e.isArray(this.scope[this.mappedProperty])&&(i===void 0||t>=this.scope[this.mappedProperty].length)){this.scope[this.mappedProperty].push(i===void 0?t:i)}else{this.scope[this.mappedProperty][t]=i===void 0?t:i}return this},apply:function(){var t;if(this.rootScope){t=this.rootScope}else{t=this.scope}if(t.$applyAsync){t.$applyAsync()}return this},clear:function(){e.isString(this.mappedProperty)?this.scope[this.mappedProperty]={}:this.mappedProperty(this.scope,void 0,[]);r(this.modelCache,function(t){t.$$free()});this.modelCache={};return this},collection:function(){return this},del:function(t){if(e.isFunction(this.transport[this.delMethod])===false){throw new Error("[delete] transport method required.")}return i(function(i,s){this.transport[this.delMethod](this.get(t),this.get(t)).then(function(s){if(e.isArray(this.scope[this.mappedProperty])){this.scope[this.mappedProperty].splice(t,1)}else{delete this.scope[this.mappedProperty][t]}i(s)}.bind(this),s)}.bind(this))},on:function(t,e){var i=false;if(t in this.scope[this.mappedProperty]){this.k=t}else{e=e?n(e,this.defaults):this.defaults;if(e!==void 0){this.k=this.set(t,e);i=true}else{throw new Error("Key is not defined: "+t)}}if("$$isCached"in this.scope[this.mappedProperty][this.k]){return this.modelCache[this.scope[this.mappedProperty][this.k].$$isCached]}var s=this.modelCache[this.modelCacheIndex++]=this.modelFactory(this,this.k,i);this.get(this.k).$$isCached=this.modelCacheIndex-1;return s},one:function(t,s){if(e.isFunction(this.transport[this.oneMethod])===false){throw new Error("[getOne] transport method required.")}return i(function(i,r){this.transport.responseSimpleOnce=true;this.transport[this.oneMethod](t).then(function(t){var r=e.isFunction(this.mappedProperty)?this.mappedProperty(this.scope,s||true,t):this.set(s||t[this.modelMapper],t);i(t)}.bind(this),r)}.bind(this))},put:function(t,s){if(e.isFunction(this.transport[this.putMethods[0]])===false||e.isFunction(this.transport[this.putMethods[1]])===false){throw new Error("[create] or [update] transport method required.")}var n=[];r(t!==void 0?[this.get(t)]:this.get(),function(t){n.push(this.transport[this.putMethods[s===true?0:1]](t,t))}.bind(this));return i.all(n)},remove:function(t){delete this.modelCache[this.scope[this.mappedProperty][t].$$isCached];if(e.isArray(this.scope[this.mappedProperty])){this.scope[this.mappedProperty].splice(t,1)}else{delete this.scope[this.mappedProperty][t]}return this},simplified:function(){this.modelFactory=d;return this}};function p(t,e,s){this.$$isDirty=this.$$isNew=s===true;this.get=function(i,s){return t.get(e+"."+i,s)};this.set=function(i,s){return(this.$$isDirty=true)&&t.set(e+"."+i,s)?this:this};this.$$free=function(){t=null};this.del=function(){return i(function(i,s){t.del(e).then(function(e){t=null;i(e)},s)})};this.put=function(){return i(function(i,s){this.$$isDirty?t.put(e,this.$$isNew).then(function(t){this.$$isDirty=this.$$isNew=false;i(t)}.bind(this),s):i()}.bind(this))};if(t.methods){for(var r in t.methods){this[r]=t.methods[r]}}}p.setPrototype=function(t){p.prototype=t;return p};function a(t,e,s){this.$$isDirty=this.$$isNew=s===true;Object.defineProperty(this,"_",{get:function(){return t.getRoot(e)}});Object.defineProperty(this,"$",{get:function(){return t.apply()&&t.getRoot(e)}});this.$$free=function(){t=null};this.del=function(){return i(function(i,s){t.del(e).then(function(e){t=null;i(e)},s)})};this.put=function(){return i(function(i,s){this.$$isDirty?t.put(e,this.$$isNew).then(function(t){this.$$isDirty=this.$$isNew=false;i(t)}.bind(this),s):i()}.bind(this))};if(t.methods){for(var r in t.methods){this[r]=t.methods[r]}}}a.setPrototype=function(t){a.prototype=t;return a};function c(t,e,i,s,r){return new u(t,e,i,s,r)}function l(t,e,i){return new(p.setPrototype(t.get(e)))(t,e,i)}function d(t,e,i){return new(a.setPrototype(t.get(e)))(t,e,i)}return c}])})(window,window.angular);if(typeof module!=="undefined"&&typeof exports!=="undefined"&&module.exports===exports){module.exports="angular-entity"}